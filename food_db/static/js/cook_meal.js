let countLabel = document.querySelector("#cooked_count_label")

let recipeTitleH1 = document.querySelector('#recipe_title')
let recipeTitle = recipeTitleH1.textContent.replace('\n','').trim()

async function cookMeal() {
    console.log(`Cooking ${recipeTitle}!`)
    // Both of the <svg> elements are auto-generated by Font Awesome magic
    // So I modify them in the browser, rather than doing this with HTML and CSS
    let upvoteSvgBefore = document.querySelector("svg#cooked_recipe_upvote_icon_before") 
    let upvoteSvgAfter = document.querySelector("svg#cooked_recipe_upvote_icon_clicked") 
    
    if ( upvoteSvgBefore.getAttribute('api_return_successful') != 'true' ) {
        
        let currentUrl = window.location.href
        let currentUrlDomain = currentUrl.split("/recipe/")[0]

        let cookedMealResponse = await fetch(`${currentUrlDomain}/cook/`, {
            method: "POST",
            body: recipeTitle,
        })
        .then(function(response) {
            // The response is a Response instance.
            console.log(`Response status: ${response.status}`)
            if (response.status == 200) {
                upvoteSvgBefore.setAttribute('api_return_successful','true')
                // "success!" color
                upvoteSvgBefore.children[0].style.color = 'green'
            }
            else {
                // "fail :(" color
                upvoteSvgBefore.children[0].style.color = 'red'
            }
            return response.text()
        })

        countLabel.textContent = `Cooked ${cookedMealResponse} time`
        if (cookedMealResponse != "1") {
            countLabel.textContent += 's'
        }

        // Get the guts of the <path> element inside the "after" icon tell the browser what to draw
        let afterIconPath = upvoteSvgAfter.children[0].getAttribute('d') 
        
        // Update the path of the before to match the after (the after is not placed correctly on page and I didn't think of a better way to do this so /shrug)
        upvoteSvgBefore.children[0].setAttribute('d', afterIconPath)
    }       
}

let upvoteButton = document.querySelector('#upvote_button_div')
upvoteButton.addEventListener('click', function() {
    cookMeal()
})